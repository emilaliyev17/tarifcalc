<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}NEXUS COGS Calculator{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <style>
    /* Dark mode styles */
    [data-theme="dark"] {
        background-color: #1a1a1a;
        color: #e0e0e0;
    }
    
    [data-theme="dark"] .navbar {
        background-color: #2d2d2d !important;
    }
    
    [data-theme="dark"] .navbar-brand,
    [data-theme="dark"] .navbar-nav .nav-link {
        color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .card {
        background-color: #2d2d2d;
        color: #e0e0e0;
        border-color: #444;
    }
    
    [data-theme="dark"] .card-header {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border-bottom-color: #444;
    }
    
    [data-theme="dark"] .table {
        color: #e0e0e0;
        border-color: #444;
    }
    
    [data-theme="dark"] .table thead th {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border-color: #444;
    }
    
    [data-theme="dark"] .table td {
        background-color: #2d2d2d;
        color: #e0e0e0;
        border-color: #444;
    }
    
    [data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) {
        background-color: #252525;
    }
    
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-select {
        background-color: #2d2d2d;
        color: #e0e0e0;
        border-color: #444;
    }
    
    [data-theme="dark"] .form-control:focus,
    [data-theme="dark"] .form-select:focus {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    [data-theme="dark"] .form-label {
        color: #e0e0e0;
    }
    
    [data-theme="dark"] .modal-content {
        background-color: #2d2d2d;
        color: #e0e0e0;
    }
    
    [data-theme="dark"] .modal-header {
        border-bottom-color: #444;
    }
    
    [data-theme="dark"] .modal-footer {
        border-top-color: #444;
    }
    
    [data-theme="dark"] .alert-info {
        background-color: #1c3d5a;
        border-color: #2c5282;
        color: #bee3f8;
    }
    
    [data-theme="dark"] .btn-close {
        filter: invert(1);
    }
    
    [data-theme="dark"] .text-muted {
        color: #999 !important;
    }
    
    [data-theme="dark"] h1,
    [data-theme="dark"] h2,
    [data-theme="dark"] h3,
    [data-theme="dark"] h4,
    [data-theme="dark"] h5,
    [data-theme="dark"] h6 {
        color: #e0e0e0;
    }
    
    [data-theme="dark"] .bg-light {
        background-color: #2d2d2d !important;
    }
    
    [data-theme="dark"] .bg-dark {
        background-color: #1a1a1a !important;
    }
    
    [data-theme="dark"] .text-dark {
        color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] a {
        color: #66b3ff;
    }
    
    [data-theme="dark"] a:hover {
        color: #99ccff;
    }
    
    [data-theme="dark"] .dropdown-menu {
        background-color: #2d2d2d;
        border-color: #444;
    }
    
    [data-theme="dark"] .dropdown-item {
        color: #e0e0e0;
    }
    
    [data-theme="dark"] .dropdown-item:hover {
        background-color: #3a3a3a;
        color: #fff;
    }
    
    /* Keep button colors visible in dark mode */
    [data-theme="dark"] .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }
    
    [data-theme="dark"] .btn-success {
        background-color: #198754;
        border-color: #198754;
        color: white;
    }
    
    [data-theme="dark"] .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }
    
    [data-theme="dark"] .btn-info {
        background-color: #0dcaf0;
        border-color: #0dcaf0;
        color: black;
    }
    
    [data-theme="dark"] .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    
    /* Smooth transition */
    * {
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    /* Fix harsh white elements in dark mode */
    [data-theme="dark"] {
        background-color: #1a1a1a;
        color: #e0e0e0;
    }

    /* Fix white backgrounds in cards and containers */
    [data-theme="dark"] .container,
    [data-theme="dark"] .container-fluid {
        background-color: transparent;
    }

    [data-theme="dark"] body {
        background-color: #1a1a1a;
    }

    /* Home page hero section */
    [data-theme="dark"] .jumbotron,
    [data-theme="dark"] .hero-section,
    [data-theme="dark"] .welcome-section {
        background-color: #2d2d2d;
        color: #e0e0e0;
    }

    /* Any white/light gray text blocks */
    [data-theme="dark"] .text-center,
    [data-theme="dark"] .text-start,
    [data-theme="dark"] .text-end {
        color: #e0e0e0;
    }

    /* Fix any remaining white divs */
    [data-theme="dark"] div[style*="background: white"],
    [data-theme="dark"] div[style*="background-color: white"],
    [data-theme="dark"] div[style*="background:#fff"],
    [data-theme="dark"] div[style*="background-color:#fff"] {
        background-color: #2d2d2d !important;
    }

    /* Fix large white text */
    [data-theme="dark"] h1.display-4,
    [data-theme="dark"] .display-1,
    [data-theme="dark"] .display-2,
    [data-theme="dark"] .display-3,
    [data-theme="dark"] .display-4 {
        color: #e0e0e0;
        opacity: 0.95;
    }

    /* Make sure all paragraphs are readable */
    [data-theme="dark"] p {
        color: #d0d0d0;
    }

    /* Fix any Bootstrap white utilities */
    [data-theme="dark"] .bg-white {
        background-color: #2d2d2d !important;
    }

    [data-theme="dark"] .text-white {
        color: #e0e0e0 !important;
    }

    /* Soften any pure white borders */
    [data-theme="dark"] .border {
        border-color: #444 !important;
    }

    [data-theme="dark"] .border-white {
        border-color: #555 !important;
    }

    /* Applied Freight Costs card specific fix */
    [data-theme="dark"] .card {
        background-color: #2d2d2d;
        color: #e0e0e0;
    }

    [data-theme="dark"] .card-body {
        background-color: #2d2d2d;
    }

    /* Main content areas */
    [data-theme="dark"] main,
    [data-theme="dark"] .main-content {
        background-color: #1a1a1a;
    }

    /* Remove any box shadows that create white glows */
    [data-theme="dark"] * {
        box-shadow: none !important;
    }

    /* Add subtle dark shadows if needed */
    [data-theme="dark"] .card,
    [data-theme="dark"] .modal-content {
        box-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;
    }

    /* Fix white input fields in dark mode */
    [data-theme="dark"] input[type="text"],
    [data-theme="dark"] input[type="number"],
    [data-theme="dark"] input[type="email"],
    [data-theme="dark"] input[type="password"],
    [data-theme="dark"] input[type="search"],
    [data-theme="dark"] input[type="date"],
    [data-theme="dark"] input[type="file"],
    [data-theme="dark"] textarea,
    [data-theme="dark"] select,
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-select {
        background-color: #2a2a2a !important;
        color: #e0e0e0 !important;
        border: 1px solid #404040 !important;
    }

    /* When focused */
    [data-theme="dark"] input[type="text"]:focus,
    [data-theme="dark"] input[type="number"]:focus,
    [data-theme="dark"] textarea:focus,
    [data-theme="dark"] .form-control:focus,
    [data-theme="dark"] .form-select:focus {
        background-color: #333333 !important;
        color: #ffffff !important;
        border-color: #4a4a4a !important;
        box-shadow: 0 0 0 0.2rem rgba(100, 100, 100, 0.25) !important;
    }

    /* Placeholder text */
    [data-theme="dark"] input::placeholder,
    [data-theme="dark"] textarea::placeholder {
        color: #808080 !important;
        opacity: 0.7;
    }

    /* File input specific */
    [data-theme="dark"] input[type="file"]::file-selector-button {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border: 1px solid #505050;
    }

    /* Disabled inputs */
    [data-theme="dark"] input:disabled,
    [data-theme="dark"] .form-control:disabled {
        background-color: #1f1f1f !important;
        color: #606060 !important;
    }

    /* Chrome autofill fix */
    [data-theme="dark"] input:-webkit-autofill,
    [data-theme="dark"] input:-webkit-autofill:hover,
    [data-theme="dark"] input:-webkit-autofill:focus {
        -webkit-text-fill-color: #e0e0e0 !important;
        -webkit-box-shadow: 0 0 0px 1000px #2a2a2a inset !important;
        box-shadow: 0 0 0px 1000px #2a2a2a inset !important;
    }

    /* Labels near inputs */
    [data-theme="dark"] label {
        color: #d0d0d0 !important;
    }

    /* Help text */
    [data-theme="dark"] .form-text,
    [data-theme="dark"] small {
        color: #999999 !important;
    }

    [data-theme="dark"] input[type="file"] {
        color: #b0b0b0 !important;
    }
/* Full width results table with sticky header */
.results-table-container {
    width: 100%;
    overflow: auto; /* Use auto for both scrollbars */
    max-height: 75vh; /* Limit height to enable internal scroll */
    border: 1px solid #ddd;
    border-radius: 4px;
}

[data-theme="dark"] .results-table-container {
    border-color: #444;
}

.results-table {
    width: 100%;
}

/* Sticky header on scroll */
.results-table thead th { /* Apply to th for better compatibility */
    position: sticky;
    top: 0; /* Stick to the top of the container */
    z-index: 10; /* Lower z-index is fine here */
    background: white;
}

[data-theme="dark"] .results-table thead th {
    background: #2d2d2d;
}

/* No text wrapping for specific columns */
.results-table td.nowrap,
.results-table th.nowrap {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* SKU specific styling */
.sku-column {
    min-width: 150px;
    max-width: 250px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Date column */
.date-column {
    white-space: nowrap;
    min-width: 100px;
}

/* Resizable columns */
.results-table th {
    position: relative;
    border-right: none !important; /* Remove default border */
}

.results-table th .resizer {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    height: 50%; /* Shorter */
    width: 1px;
    background: #ccc;
    cursor: col-resize;
    opacity: 0.5;
    transition: all 0.2s ease;
}

.results-table th .resizer:hover,
.results-table th:hover .resizer {
    opacity: 1;
    background-color: #0d6efd;
    width: 3px;
}

[data-theme="dark"] .results-table th .resizer {
    background: #555;
}



/* Remove container padding for full width */
.container-fluid.results-full-width {
    padding-left: 10px;
    padding-right: 10px;
}
/* Full width results */
.results-page .container-fluid {
    max-width: 100%;
    padding-left: 15px;
    padding-right: 15px;
}

.results-page .table-responsive {
    overflow-x: auto;
}

.results-page table {
    width: 100%;
    min-width: 1400px; /* Ensure minimum width for all columns */
}

/* Remove any max-width constraints */
.results-page {
    width: 100%;
}
</style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">NEXUS COGS</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'invoice_upload' %}">Upload Invoice</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'sku_list' %}">Manage SKUs</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'htsus_code_list' %}">HTSUS Directory</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'results' %}">Results</a></li>
                
<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="tariffDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        Tariff
    </a>
    <ul class="dropdown-menu" aria-labelledby="tariffDropdown">
        <li><a class="dropdown-item" href="{% url 'tariff_shipment_entry' %}">Shipment</a></li>
        <li><a class="dropdown-item" href="{% url 'tariff_upload' %}">Upload</a></li>
        <li><a class="dropdown-item" href="{% url 'tariff_match' %}">Match</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{% url 'tariff_countries' %}">Countries</a></li>
    </ul>
</li>
</ul>
                <div class="ms-auto d-flex align-items-center">
                    <button class="btn btn-outline-secondary btn-sm" id="themeToggle" onclick="toggleTheme()" title="Toggle dark/light mode">
                        <span id="themeIcon">ðŸŒ™</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        {% block content %}
        {% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme toggle functionality
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            }
        }
        
        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', initTheme);

        function addNewCost() {
    var modal = new bootstrap.Modal(document.getElementById('addNewCostModal'));
    modal.show();
}

        

        function applyNewCost() {
    const costName = document.getElementById('costName').value;
    const costAmount = document.getElementById('costAmount').value;
    const scope = document.getElementById('allocationScope').value;
    const method = document.getElementById('allocationMethod').value;
    
    if (!costName || !costAmount || !scope || !method) {
        alert('Please fill in all fields');
        return;
    }
    
    fetch('/legacy/add-custom-cost/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            cost_name: costName,
            cost_amount: parseFloat(costAmount),
            allocation_scope: scope,
            allocation_method: method
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addNewCostModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    });
}

function addFreightCost() {
    var freightModal = new bootstrap.Modal(document.getElementById('freightCostModal'));
    freightModal.show();
}

        function applyFreightCost() {
    const totalFreight = document.getElementById('totalFreightCostInput').value;
    const shipmentCompany = document.getElementById('shipmentCompany').value;
    const shipmentInvoice = document.getElementById('shipmentInvoice').value;
    
    if (!totalFreight || totalFreight <= 0) {
        alert('Please enter a valid freight cost amount');
        return;
    }
    
    fetch('/legacy/add-freight-cost/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            total_freight_cost: parseFloat(totalFreight),
            shipment_company: shipmentCompany,
            shipment_invoice: shipmentInvoice
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('freightCostModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        } 
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to apply freight cost');
    });
}

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
